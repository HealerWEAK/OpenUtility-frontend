name: Frontend Deployment to ECS

on:
  push:
    branches: [ "master" ]  # 仅当 master 分支有提交时触发

jobs:
  deploy:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4  # 检出当前的仓库代码

    # 部署到 ECS
    - name: Deploy frontend to ECS
      env:
        ECS_HOST: ${{ secrets.ECS_HOST }}         # ECS 的公网 IP
        ECS_USER: ${{ secrets.ECS_USER }}         # SSH 用户名
        ECS_KEY: ${{ secrets.ECS_KEY }}           # SSH 私钥
        APP_PATH: "/home/openutility_frontend"    # ECS 上的目标路径
      run: |
        # 添加私钥到 SSH 配置
        echo "${ECS_KEY}" > ecs_key.pem
        chmod 600 ecs_key.pem

        # 使用 ssh-keyscan 信任 ECS 主机
        mkdir -p ~/.ssh
        ssh-keyscan -H $ECS_HOST >> ~/.ssh/known_hosts

        # 确保远程路径存在
        ssh -i ecs_key.pem $ECS_USER@$ECS_HOST "mkdir -p $APP_PATH"

        # 将本地仓库内容传输到远程服务器
        scp -r -i ecs_key.pem ./css ./html ./js $ECS_USER@$ECS_HOST:$APP_PATH

        # 可选：清理远程目标文件夹中多余的旧文件
        ssh -i ecs_key.pem $ECS_USER@$ECS_HOST -tt<< EOF
        # 确保目标路径只保留最新的内容
        cd $APP_PATH
        ls
        exit
        EOF
